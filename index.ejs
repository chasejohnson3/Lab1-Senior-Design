<html>
  <head>
  <script language="JavaScript">
  // <!-- hide this script from old browsers
  function tempSwap(form)
  {
    var f = parseFloat(form.DegF.value, 10);
    var c = 0;
    c = (f - 32.0) * 5.0 / 9.0;
    form.DegC.value = c;
  }
  
  function refresh()
  {
    window.location.href = "./";
  }


  // done hiding from old browsers -->
  // Credit: https://computer.howstuffworks.com/javascript.htm
  //Information for setting up Ploty: https://plot.ly/javascript/getting-started/
  //Look at https://www.youtube.com/watch?v=2-tnkzG0sKU for information on plotting using Plotly
  </script>
	<style type="text/css">
   div.bold-red {
      color: red;
      font-weight: bold;
	}
</style>
  <!--Include the plotly library -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"
			  integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
			  crossorigin="anonymous"></script>
  
  </head>
  <body>
  <FORM>
  <h1>Real-Time Temperature Sensor Web Interface </h1>
  
  <h1 class="tempArr" style="visibility: hidden;height:0px"><%= tempArr%></h1>

  <h2 class="timeArr" style="visibility: hidden;height:0px"><%= timeArr%></h2>

  <div id="tester" style="width:800px;height:350px;"></div>
  <!-- <h1 id="test">aldsfk</h1> -->
  <script>
  // Set limits on axes
  
    var url = new URL(window.location.href);

    var tempArrStr = document.querySelector(".tempArr").textContent;
    var timeArrStr = document.querySelector(".timeArr").textContent;

    console.log("Temp arr str is " + tempArrStr);
    console.log("Time arr str is " + timeArrStr);
	
    var tempArr = tempArrStr.split(',').map(function(item){
      return parseInt(item, 10);
    });
    var timeArr = timeArrStr.split(',').map(function(item){
      return parseInt(item, 10);
    });
	
    console.log("Temp arr is " + tempArr);
    console.log("Time arr is " + timeArr);

  
  TESTER = document.getElementById('tester');
	  
	//Gloabal Variable in this script used to track degree units. 0 = degC, 1 = degF  
	var degCorDegF = 0;
	function tempUnitSwap(){
  	  degCorDegF = !degCorDegF;
  }


	var lengthTimeArr = 0; // Glob var for cheking whether timeArr has changed, (when Pi is off)
	var time = 0; // Global variable for continuously couting time
	var timeArr = [], tempArr = []; // Global arrays for continuous graph
	var message = '';
	setInterval(function(){
		$.get('/sendTemps', function(data, status){
			var timeArr2 = data[1];
			var tempArr2 = data[0];
			timeArr.push(time); // INcrease time always for the graph
      time++;
			if(lengthTimeArr == timeArr2.length){
        // PI is off
				tempArr.push(null);
				message = "System OFF";
			}else{
				// Pi is on
				tempArr.push(tempArr2[tempArr2.length - 1]); // Put the value for this time regardless if its null or not
				
				if(tempArr2[tempArr2.length - 1] == null){
					message = "UNPLUGGED SENSOR";
				}else{
					if(degCorDegF == 0){
						message = tempArr2[tempArr2.length-1] + " degC";
					} else{
				      //Convert the current Temp to degF
						var currTempC = tempArr[tempArr.length-1];
						var currTempF = (currTempC*(9/5) + 32);

						message = currTempF + " degF";
				  }
				}
			}
			
			lengthTimeArr = timeArr2.length; // Update the leght of time from the Database
			document.getElementById("insttemp").textContent = message;
			
			var layout = {
			  xaxis: {
				title: { text: 'Seconds Ago from Current Time (s)'},
				range: [timeArr[timeArr.length-1]-300, timeArr[timeArr.length-1]] 
			  }, 
			  yaxis:{
				title: {text: "Temperature (degC)"},
				range: [10, 50] }, 
				title: { text: 'Temperature vs Time'},
        
			};

			Plotly.newPlot(TESTER, [{
			x: timeArr,
			y: tempArr, type:'scatter', marker: {
        color: 'rgba(252,141,98,1)',
        line: {color: 'black'}
      }}] ,
			layout, {showSendToCloud: true});

			console.log(timeArr2);
			console.log(tempArr2);
			
		  //     //******** Print the instantaneous Temp below the Temp graph **********//
		  //     if(tempArr[tempArr.length-1] == null){
			// document.getElementById("insttemp").textContent = "UNPLUGGED SENSOR";
		  //     }	
		  //     //The user wants instantaneous temp in Celsius
		  //     else if(degCorDegF == 0){
			// document.getElementById("insttemp").textContent = tempArr[tempArr.length-1] + " degC";
		  //     }
		  //     //The user wants instantaneous temp in Fahrenheit 
		  //     else{
		  //     //Convert the current Temp to degF
      //       var currTempC = tempArr[tempArr.length-1];
      //       var currTempF = (currTempC*(9/5) + 32);

      //       document.getElementById("insttemp").textContent = currTempF + " degF";
		  //     }


		    if(tempArr[tempArr.length-1] != null && (tempArr[tempArr.length-2] != tempArr[tempArr.length-1])){
		      //sendText(tempArr);
		    }
  	});

	}, 1000);
	
	//Call the logic at /display every second to get the latest 	
	setInterval(function(){
		var disPwr = 1;
		$.get('/display', function(data, status){
			disPwr = data[0];
		});

	}, 100);	
	
	
</script>


<script>
    function sendText(tempArr) {
      var carrierExt = document.getElementById("carrierExt").value;
      var phoneNum = document.getElementById("phoneNum").value;
      var maxMsg = "";
      if (tempArr[tempArr.length-1] > parseInt(document.getElementById("maxTemp").value)) {
        var maxMsg = document.getElementById("maxMessage").value;
      }
      var minMsg = "";
      if (tempArr[tempArr.length-1] < parseInt(document.getElementById("minTemp").value)) {
        var minMsg = document.getElementById("minMessage").value;
      }	   
      url = "./sendText?phoneNum=" + phoneNum + "&carrierExt=" + carrierExt + "&minMsg=" + minMsg + "&maxMsg=" + maxMsg;
      //url = "./sendText?email=" + phoneNum + "&minMsg=" + minMsg + "&maxMsg=" + maxMsg;
      console.log(url);
      $.get(url); // Uncommet this line after verifying. this sends the text request
    }
</script>
<script>
	// Calls the logic at /sendDisplayStatus in index.js to write display status to database
	function toggleDisplay()
	{
			$.post("/sendDisplayStatus")
	}
</script>

  
<p> 
<p id="demo"></p>
<p>
	 <div id="insttemp" class="bold-red"></div>
  <h2>User Input Form</h2>
  Enter a max temp threshold in degrees C:
  <INPUT id="maxTemp" NAME ="maxThreshold" VALUE="60">
  <p>
  Enter max temp warning text message :
  <INPUT id="maxMessage" NAME ="maxMessage" VALUE="Max Temp Warning">
  <p>
  Enter a min temp threshold in degrees C:
  <INPUT id="minTemp" NAME ="minThreshold" VALUE="0">
  <p>
  Enter min temp warning text message :
  <INPUT id="minMessage" NAME ="minMessage" VALUE="Min Temp Warning">
  <p>
  Enter a text-alert phone number (ex. 3196657091):
  <INPUT id="phoneNum" NAME ="phoneNumber" VALUE="8158760522">
  <select id="carrierExt">
    <option value="@messaging.sprintpcs.com">Sprint</option>
    <option value="@email.uscc.net">US Cellular</option>
    <option value="@vtext.com">Verizon</option>
    <option value="@txt.att.net">AT&T</option>
  </select>
  <input type=button onclick="sendText()"   value="Send Text"/>
  
  <p> 
  Toggle instantaneous temp reading:
  <INPUT NAME="degSwap" VALUE="degC <-> degF" TYPE=BUTTON 
  onClick=tempUnitSwap()>
  <p>
  Toggle thermostat display
  <INPUT NAME="displayPower" VALUE="Dispaly OFF/ON" TYPE=BUTTON 
  onClick=toggleDisplay(this.form)>
  <p>
  
  </FORM>
  
  <div id="tester2" style="width:600px;height:250px;"></div>
  <script>
  var trace1 = {
    x: [1, 2, 3, 4],
    y: [10, 15, 13, 17],
    type: 'scatter',
  };
  
  var trace2 = {
    x: [1, 2, 3, 4],
    y: [16, 5, 11, 9],
    type: 'scatter'
  };
  
  var data = [trace1, trace2];
  
  Plotly.newPlot(tester2, data, {}, {showSendToCloud: true});
  
  var layout = {
    xaxis: {
      title: { text: 'Seconds Ago from Current Time (s)'},
      range: [0, 300] 
    }, 
    yaxis:{
      title: {text: "Temperature (degC)"},
      range: [10, 50] }, 
      title: { text: 'Temperature vs Time'}
    };

    var x2 = [1, 2, 3, 4, 5];
    var y2 = [16, 5, 11, 9, 4];
	setInterval(function(){ 
    var number = x2[x2.length - 1]+1;
    x2.push(number);
    var randNum2 = Math.floor((Math.random() * 10) + 10);
    if(randNum2 < 15){
      randNum2 = null;
    }
    y2.push(randNum2);

    var layout = {
        xaxis: {
          title: { text: 'Seconds Ago from Current Time (s)'},
          range: [x2.length - 10, x2.length] 
      }
    };

    var trace2 = {
      x: x2,
      y: y2,
      type: 'scatter'
    };

    var data = [trace2];

    Plotly.newPlot(tester2, data, layout, {showSendToCloud: true});

   }, 1000);
  </script>
  
  </body>
  </html>
